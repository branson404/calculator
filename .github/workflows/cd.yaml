# .github/workflows/deploy-template.yml
name: Reusable Helm Deploy Job (via SSH)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'The target environment (e.g., minikube, staging)'
      image_tag:
        required: true
        type: string
        description: 'The Docker image tag to deploy (CI commit SHA)'
      docker_repo:
        required: true
        type: string
        description: 'The Docker repository'

jobs:
  helm-deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }} # Uses GitHub Environments for approvals/protection

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        
      # --- SSH Setup ---
      - name: Set up SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add EC2 Host to Known Hosts
        # This prevents the workflow from failing on first connection due to host key checking
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
      # --- File Transfer ---
      - name: Transfer Helm Chart to EC2
        run: |
          SSH_TARGET="${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
          
          # Use rsync to transfer the Helm chart directory (assuming it's named 'helm')
          # to a temporary location on the remote EC2 host.
          # The -a (archive) flag is highly recommended.
          rsync -avz --exclude '.git' helm "${SSH_TARGET}:/tmp/helm-deploy/"
          
      # --- Helm Deployment via SSH ---
      - name: Execute Remote Helm Upgrade
        run: |
          SSH_TARGET="${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}"
          TEMP_CHART_PATH="/tmp/helm-deploy/helm"
          
          # Execute the deployment script remotely using the transferred chart files.
          # The Helm command uses the exact structure you specified.
          ssh "${SSH_TARGET}" << EOF
            echo "Starting remote Helm upgrade on Minikube..."
            
            # Run the helm upgrade command
            helm upgrade --install calculator "${TEMP_CHART_PATH}" \
              --set image.repository=${{ inputs.docker_repo }} \
              --set image.tag=${{ inputs.image_tag }} \
              --namespace default \
              --wait
              
            echo "--- Verification ---"
            # Verify Deployment Status
            kubectl rollout status deployment/calculator -n default --timeout=5m
            kubectl get pods -n default
          EOF
          
      - name: Clean up temporary files on EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "rm -rf /tmp/helm-deploy"
